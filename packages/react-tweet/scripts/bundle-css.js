#!/usr/bin/env node

import { readFileSync, writeFileSync, readdirSync, statSync, existsSync } from 'fs'
import { join, dirname } from 'path'
import { fileURLToPath } from 'url'

const __dirname = dirname(fileURLToPath(import.meta.url))
const distDir = join(__dirname, '../dist')
const twitterThemeDir = join(distDir, 'twitter-theme')
const shadowDomDir = join(twitterThemeDir, 'shadow-dom')

function getAllCssFiles(dir, files = [], excludeDirs = []) {
  if (!existsSync(dir)) return files

  const entries = readdirSync(dir)
  for (const entry of entries) {
    const fullPath = join(dir, entry)
    const stat = statSync(fullPath)
    if (stat.isDirectory()) {
      if (!excludeDirs.includes(entry)) {
        getAllCssFiles(fullPath, files, excludeDirs)
      }
    } else if (entry.endsWith('.css')) {
      files.push(fullPath)
    }
  }
  return files
}

function bundleCss() {
  // Get CSS files, excluding shadow-dom directory (those are processed separately)
  const cssFiles = getAllCssFiles(twitterThemeDir, [], ['shadow-dom'])

  // theme.css should be first
  cssFiles.sort((a, b) => {
    if (a.endsWith('theme.css')) return -1
    if (b.endsWith('theme.css')) return 1
    return a.localeCompare(b)
  })

  const cssContents = cssFiles.map((file) => {
    const content = readFileSync(file, 'utf-8')
    return `/* ${file.replace(twitterThemeDir + '/', '')} */\n${content}`
  })

  const bundledCss = cssContents.join('\n\n')

  // Write the bundled CSS file (without shadow-dom CSS)
  const bundledCssPath = join(distDir, 'styles.css')
  writeFileSync(bundledCssPath, bundledCss)
  console.log(`Bundled CSS written to: ${bundledCssPath}`)

  // Now read shadow-dom theme CSS and append it for JS module only
  const shadowThemePath = join(shadowDomDir, 'shadow-theme.css')
  let shadowThemeCss = ''
  if (existsSync(shadowThemePath)) {
    shadowThemeCss = readFileSync(shadowThemePath, 'utf-8')
    console.log(`Shadow DOM theme CSS read from: ${shadowThemePath}`)
  }

  // Generate TypeScript module for Shadow DOM injection (includes shadow-dom CSS)
  const fullCssForShadowDom = bundledCss + '\n\n' + shadowThemeCss

  const stylesModulePath = join(distDir, 'styles.js')
  const stylesDtsPath = join(distDir, 'styles.d.ts')

  const jsContent = `// Auto-generated by scripts/bundle-css.js
export const tweetStyles = ${JSON.stringify(fullCssForShadowDom)};
`

  const dtsContent = `// Auto-generated by scripts/bundle-css.js
export declare const tweetStyles: string;
`

  writeFileSync(stylesModulePath, jsContent)
  writeFileSync(stylesDtsPath, dtsContent)
  console.log(`Styles module written to: ${stylesModulePath}`)
}

bundleCss()
